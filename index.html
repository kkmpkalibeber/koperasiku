<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Koperasi Sekolah â€” Aplikasi</title>
<style>
  :root{--accent:#0b63d7;--bg:#f4f7fb;--card:#fff;--muted:#6b7280;}
  body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;margin:0;background:var(--bg);color:#0b1a2b;}
  .app{display:flex;min-height:100vh;}
  .sidebar{width:240px;background:linear-gradient(180deg,#06283D,#0b63d7);color:#fff;padding:24px;box-sizing:border-box;}
  .brand{font-weight:700;font-size:18px;margin-bottom:8px;}
  .menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:none;background:transparent;color:#fff;margin-bottom:6px;cursor:pointer;}
  .menu button.active{background:rgba(255,255,255,0.06);}
  .main{flex:1;padding:20px;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
  .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:16px;}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
  .btn.ghost{background:transparent;border:1px solid rgba(11,94,215,0.12);color:var(--accent);}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:8px 10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;}
  th{font-weight:700;background:linear-gradient(90deg, rgba(11,94,215,0.04), transparent);}
  tr:nth-child(even) td{background:#fbfdff;}
  .form-row{display:flex;gap:10px;margin-bottom:10px;}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef7;}
  .small{font-size:13px;color:var(--muted);}
  @media(max-width:900px){ .sidebar{display:none;} .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">Koperasi Sekolah</div>
    <div class="small">Kelola anggota, transaksi, jurnal & laporan</div>
    <nav class="menu" id="menu">
      <button data-page="dashboard" class="active">Dashboard</button>
      <button data-page="anggota">Master Anggota</button>
      <button data-page="jenis">Master Jenis Transaksi</button>
      <button data-page="transaksi">Transaksi</button>
      <button data-page="jurnal">Jurnal Umum</button>
      <button data-page="laporan">Laporan Periode</button>
    </nav>
    <div style="position:absolute;bottom:18px;left:24px;right:24px;" class="small">Deploy Web App & ganti URL di pengaturan.</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h2 id="page-title">Login</h2>
        <div id="user-welcome" class="small" style="display:none;">Selamat datang, <span id="user-name"></span></div>
      </div>
      <div class="right">
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </div>

    <div id="content">
      <!-- LOGIN -->
      <div id="page-login" class="card">
        <h3>Login</h3>
        <div class="form-row">
          <input id="login-username" placeholder="username (default: admin)" />
          <input id="login-password" type="password" placeholder="password (default: 123)" />
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn" onclick="doLogin()">Masuk</button>
          <button class="btn ghost" onclick="fillDemo()">Isi Demo</button>
        </div>
        <div id="login-msg" class="small" style="margin-top:8px;color:#a00;"></div>
      </div>

      <!-- DASHBOARD -->
      <div id="page-dashboard" class="page" style="display:none;">
        <div class="grid">
          <div class="card">
            <h3>Ringkasan</h3>
            <div id="summary" class="small">Memuat...</div>
          </div>
          <div class="card">
            <h3>Saldo Per Anggota</h3>
            <div id="saldo-list" style="max-height:240px;overflow:auto;">Memuat...</div>
          </div>
        </div>
      </div>

      <!-- MASTER ANGGOTA -->
      <div id="page-anggota" class="page" style="display:none;">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Master Anggota</h3>
            <button class="btn" onclick="showAnggotaForm()">Tambah Anggota</button>
          </div>

          <div id="anggota-form" style="margin-top:12px;display:none;">
            <div class="card">
              <h4 id="anggota-title">Tambah Anggota</h4>
              <div class="form-row">
                <input id="anggota-nama" placeholder="Nama" />
                <input id="anggota-nohp" placeholder="No. HP" />
              </div>
              <div class="form-row">
                <input id="anggota-alamat" placeholder="Alamat" />
                <div style="width:150px;"><button class="btn" onclick="saveAnggota()" id="btn-save-anggota">Simpan</button></div>
              </div>
              <input type="hidden" id="anggota-id" />
            </div>
          </div>

          <div style="margin-top:12px;overflow:auto;">
            <table id="anggota-table">
              <thead><tr><th>Nama</th><th>No HP</th><th>Alamat</th><th>Aksi</th></tr></thead>
              <tbody><tr><td colspan="4" class="small">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- MASTER JENIS -->
      <div id="page-jenis" class="page" style="display:none;">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Master Jenis Transaksi</h3>
            <button class="btn" onclick="showJenisForm()">Tambah Jenis</button>
          </div>

          <div id="jenis-form" style="margin-top:12px;display:none;">
            <div class="card">
              <h4 id="jenis-title">Tambah Jenis</h4>
              <div class="form-row">
                <input id="jenis-nama" placeholder="Nama Jenis" />
                <select id="jenis-kategori"><option value="masuk">Masuk</option><option value="keluar">Keluar</option></select>
              </div>
              <div style="margin-top:8px;"><button class="btn" onclick="saveJenis()">Simpan</button> <button class="btn ghost" onclick="hideJenisForm()">Batal</button></div>
              <input type="hidden" id="jenis-id" />
            </div>
          </div>

          <div style="margin-top:12px;overflow:auto;">
            <table id="jenis-table">
              <thead><tr><th>Nama Jenis</th><th>Kategori</th><th>Aksi</th></tr></thead>
              <tbody><tr><td colspan="3" class="small">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TRANSAKSI -->
      <div id="page-transaksi" class="page" style="display:none;">
        <div class="card">
          <h3>Transaksi</h3>
          <div class="card" style="margin-top:12px;">
            <h4 id="transaksi-title">Buat Transaksi Baru</h4>
            <div class="form-row">
              <input id="transaksi-tanggal" type="date" />
              <select id="transaksi-anggota"></select>
            </div>
            <div class="form-row">
              <select id="transaksi-jenis"></select>
              <input id="transaksi-nilai" placeholder="Nilai (angka)" />
            </div>
            <div class="form-row">
              <input id="transaksi-keterangan" placeholder="Keterangan" />
              <div style="width:150px;"><button class="btn" onclick="saveTransaksi()">Simpan</button></div>
            </div>
            <input type="hidden" id="transaksi-id" />
          </div>

          <div style="margin-top:12px;overflow:auto;">
            <table id="transaksi-table">
              <thead><tr><th>Tanggal</th><th>Anggota</th><th>Jenis (Kategori)</th><th>Nilai</th><th>Keterangan</th><th>Aksi</th></tr></thead>
              <tbody><tr><td colspan="6" class="small">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- JURNAL -->
      <div id="page-jurnal" class="page" style="display:none;">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Jurnal Umum</h3>
            <div>
              <button class="btn" onclick="exportCSV('transaksi')">Ekspor CSV Transaksi</button>
              <button class="btn ghost" onclick="refreshAll()">Refresh</button>
            </div>
          </div>

          <div style="margin-top:12px;overflow:auto;">
            <table id="jurnal-table">
              <thead><tr><th>Tanggal</th><th>Deskripsi</th><th>Debit</th><th>Kredit</th><th>Saldo</th><th>Aksi</th></tr></thead>
              <tbody><tr><td colspan="6" class="small">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- LAPORAN -->
      <div id="page-laporan" class="page" style="display:none;">
        <div class="card">
          <h3>Laporan Periode</h3>
          <div class="form-row">
            <input type="date" id="lap-start" />
            <input type="date" id="lap-end" />
            <div style="width:150px;"><button class="btn" onclick="generateReport()">Tampilkan</button></div>
          </div>
          <div style="margin-top:8px;">
            <button class="btn ghost" onclick="window.print()">Preview Print</button>
            <button class="btn" onclick="exportCSV('transaksi')">Ekspor CSV</button>
          </div>
          <div id="report-result" style="margin-top:12px;"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<script>
/* =============== PENTING ================
 Ganti WEB_APP_URL dengan URL Web App dari Apps Script (Deploy -> Web app).
========================================*/
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyy8-8ETF44tfMQ9W-lhT7Twimib1zm8RXpZWY-nNjrQvsBmhhnPBmySPMk331FQav-/exec"; // <-- GANTI DENGAN URL KAMU

// ===========================================
// HELPER FUNCTIONS - FIXED VERSION
// ===========================================

// Debug logging
function debugLog(...args) {
  console.log('[Koperasi]', ...args);
}

// Main POST function dengan error handling yang lebih baik
async function post(mode, payload = {}) {
  try {
    const body = { ...payload, mode };
    debugLog('Sending request:', mode, body);
    
    // Gunakan XMLHttpRequest untuk menghindari CORS issues
    return new Promise((resolve) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', WEB_APP_URL, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onload = function() {
        try {
          debugLog('Raw response:', xhr.responseText);
          const response = JSON.parse(xhr.responseText);
          resolve(response);
        } catch (parseErr) {
          debugLog('Parse error:', parseErr);
          resolve({ 
            success: false, 
            error: 'Invalid JSON response: ' + xhr.responseText.substring(0, 100) 
          });
        }
      };
      
      xhr.onerror = function() {
        debugLog('Network error');
        resolve({ 
          success: false, 
          error: 'Network error. Periksa koneksi internet atau URL API.' 
        });
      };
      
      xhr.timeout = 10000; // 10 detik timeout
      xhr.ontimeout = function() {
        debugLog('Request timeout');
        resolve({ 
          success: false, 
          error: 'Request timeout. Server terlalu lama merespon.' 
        });
      };
      
      xhr.send(JSON.stringify(body));
    });
    
  } catch (err) {
    debugLog('Post function error:', err);
    return { 
      success: false, 
      error: 'Client error: ' + err.toString() 
    };
  }
}

// ===========================================
// UI FUNCTIONS
// ===========================================

function setPageTitle(t) { 
  document.getElementById('page-title').innerText = t; 
}

// Navigation
document.querySelectorAll('#menu button').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('#menu button').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    showPage(b.dataset.page);
  });
});

function showPage(page) {
  setPageTitle(page.charAt(0).toUpperCase() + page.slice(1));
  
  // Hide semua page
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  document.getElementById('page-login').style.display = 'none';
  
  if (page === 'login') {
    document.getElementById('page-login').style.display = 'block';
    return;
  }
  
  // Show page yang dipilih
  const pageElement = document.getElementById('page-' + page);
  if (pageElement) {
    pageElement.style.display = 'block';
  }
  
  // Load data sesuai page
  if (page === 'dashboard') loadDashboard();
  if (page === 'anggota') loadAnggota();
  if (page === 'jenis') loadJenis();
  if (page === 'transaksi') { 
    loadDropdowns(); 
    loadTransaksi(); 
  }
  if (page === 'jurnal') loadJurnal();
}

// ===========================================
// LOGIN FUNCTIONS - FIXED
// ===========================================

async function doLogin() {
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value.trim();
  const msgElement = document.getElementById('login-msg');
  
  // Clear previous message
  msgElement.innerText = "";
  msgElement.style.color = "#a00";
  
  if (!u || !p) { 
    msgElement.innerText = "Username & password wajib diisi"; 
    return; 
  }
  
  // Show loading
  msgElement.innerText = "Memproses login...";
  msgElement.style.color = "#0b63d7";
  
  try {
    debugLog("Attempting login for:", u);
    const res = await post('login', { username: u, password: p });
    debugLog("Login response:", res);
    
    if (res.success) {
      msgElement.innerText = "Login berhasil!";
      msgElement.style.color = "#0a8";
      
      // Hide login form
      document.getElementById('page-login').style.display = 'none';
      document.getElementById('user-welcome').style.display = 'block';
      document.getElementById('user-name').innerText = res.user.username;
      
      // Show dashboard
      document.querySelectorAll('#menu button').forEach(x => x.classList.remove('active'));
      const dashboardBtn = document.querySelector('#menu button[data-page="dashboard"]');
      if (dashboardBtn) {
        dashboardBtn.classList.add('active');
      }
      showPage('dashboard');
      
      // Load initial data
      setTimeout(() => {
        loadDashboard();
      }, 300);
      
    } else {
      let errorMsg = "Login gagal";
      if (res.error) errorMsg += ": " + res.error;
      msgElement.innerText = errorMsg;
      msgElement.style.color = "#a00";
    }
  } catch (err) {
    debugLog("Login error:", err);
    msgElement.innerText = "Error: " + (err.message || err.toString());
    msgElement.style.color = "#a00";
  }
}

// demo quick-fill (buat testing)
function fillDemo() {
  document.getElementById('login-username').value = 'admin';
  document.getElementById('login-password').value = '123';
}

// ===========================================
// DASHBOARD FUNCTIONS
// ===========================================

async function loadDashboard() {
  try {
    document.getElementById('summary').innerHTML = 'Memuat...';
    
    // Load data paralel
    const [anggotaRes, jenisRes, transRes, saldoRes] = await Promise.allSettled([
      post('getAnggota'),
      post('getJenis'),
      post('getTrans'),
      post('saldoPerAnggota')
    ]);
    
    // Proses response anggota
    let anggotaCount = 0;
    if (anggotaRes.status === 'fulfilled' && anggotaRes.value.success) {
      anggotaCount = anggotaRes.value.data ? anggotaRes.value.data.length : 0;
    }
    
    // Proses response jenis
    let jenisCount = 0;
    if (jenisRes.status === 'fulfilled' && jenisRes.value.success) {
      jenisCount = jenisRes.value.data ? jenisRes.value.data.length : 0;
    }
    
    // Proses transaksi
    let pemasukan = 0, pengeluaran = 0;
    if (transRes.status === 'fulfilled' && transRes.value.success && transRes.value.data) {
      transRes.value.data.forEach(t => {
        const v = Number(t.nilai) || 0;
        if ((t.kategori || '').toLowerCase() === 'masuk') {
          pemasukan += v;
        } else {
          pengeluaran += v;
        }
      });
    }
    
    const saldo = pemasukan - pengeluaran;
    
    // Update summary
    document.getElementById('summary').innerHTML = `
      <div class="small">Anggota: <strong>${anggotaCount}</strong></div>
      <div class="small">Jenis Transaksi: <strong>${jenisCount}</strong></div>
      <div class="small">Total Pemasukan: <strong>Rp ${formatNumber(pemasukan)}</strong></div>
      <div class="small">Total Pengeluaran: <strong>Rp ${formatNumber(pengeluaran)}</strong></div>
      <div class="small">Saldo: <strong>Rp ${formatNumber(saldo)}</strong></div>
    `;
    
    // Update saldo per anggota
    const saldoList = document.getElementById('saldo-list');
    if (saldoRes.status === 'fulfilled' && saldoRes.value.success && saldoRes.value.data) {
      const html = saldoRes.value.data.map(s => 
        `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee;">
           <div>${escapeHtml(s.nama)}</div>
           <div>Rp ${formatNumber(Number(s.saldo) || 0)}</div>
         </div>`
      ).join('');
      saldoList.innerHTML = html || '<div class="small">Belum ada data</div>';
    } else {
      saldoList.innerHTML = '<div class="small">Gagal memuat saldo</div>';
    }
    
  } catch (err) {
    debugLog("Dashboard error:", err);
    document.getElementById('summary').innerHTML = '<div class="small">Error memuat data</div>';
  }
}

// ===========================================
// ANGGOTA CRUD FUNCTIONS
// ===========================================

function showAnggotaForm() {
  document.getElementById('anggota-form').style.display = 'block';
  document.getElementById('anggota-title').innerText = 'Tambah Anggota';
  document.getElementById('anggota-id').value = '';
  document.getElementById('anggota-nama').value = '';
  document.getElementById('anggota-nohp').value = '';
  document.getElementById('anggota-alamat').value = '';
}

function hideAnggotaForm() { 
  document.getElementById('anggota-form').style.display = 'none'; 
}

async function saveAnggota() {
  const id = document.getElementById('anggota-id').value;
  const nama = document.getElementById('anggota-nama').value.trim();
  const nohp = document.getElementById('anggota-nohp').value.trim();
  const alamat = document.getElementById('anggota-alamat').value.trim();
  
  if (!nama) {
    alert('Nama wajib diisi');
    return;
  }
  
  try {
    if (id) {
      // Update
      const res = await post('updateAnggota', { id, nama, no_hp: nohp, alamat });
      if (res.success) {
        alert('Data anggota diupdate');
      } else {
        alert('Gagal update: ' + (res.error || ''));
      }
    } else {
      // Add new
      const res = await post('addAnggota', { nama, no_hp: nohp, alamat });
      if (res.success) {
        alert('Anggota ditambahkan');
      } else {
        alert('Gagal tambah: ' + (res.error || ''));
      }
    }
    
    hideAnggotaForm();
    loadAnggota();
    loadDashboard();
    
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function loadAnggota() {
  try {
    const res = await post('getAnggota');
    const tbody = document.querySelector('#anggota-table tbody');
    
    if (!res.success) {
      tbody.innerHTML = '<tr><td colspan="4">Gagal memuat data</td></tr>';
      return;
    }
    
    const data = res.data || [];
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="small">Belum ada anggota</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.map(r => `
      <tr>
        <td>${escapeHtml(r.nama)}</td>
        <td>${escapeHtml(r.no_hp || '')}</td>
        <td>${escapeHtml(r.alamat || '')}</td>
        <td>
          <button class="btn ghost" onclick="editAnggota('${r.id}')">Edit</button>
          <button class="btn" onclick="deleteAnggota('${r.id}')">Hapus</button>
        </td>
      </tr>
    `).join('');
    
    // Update dropdowns jika diperlukan
    loadDropdowns();
    
  } catch (err) {
    debugLog("Load anggota error:", err);
    document.querySelector('#anggota-table tbody').innerHTML = 
      '<tr><td colspan="4">Error memuat data</td></tr>';
  }
}

async function editAnggota(id) {
  try {
    const res = await post('getAnggota');
    if (!res.success) {
      alert('Gagal memuat data anggota');
      return;
    }
    
    const rec = res.data.find(x => x.id === id);
    if (!rec) {
      alert('Data anggota tidak ditemukan');
      return;
    }
    
    document.getElementById('anggota-id').value = rec.id;
    document.getElementById('anggota-nama').value = rec.nama;
    document.getElementById('anggota-nohp').value = rec.no_hp || '';
    document.getElementById('anggota-alamat').value = rec.alamat || '';
    document.getElementById('anggota-form').style.display = 'block';
    document.getElementById('anggota-title').innerText = 'Edit Anggota';
    
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function deleteAnggota(id) {
  if (!confirm('Hapus anggota ini?')) return;
  
  try {
    const res = await post('deleteAnggota', { id });
    if (res.success) {
      alert('Anggota berhasil dihapus');
      loadAnggota();
      loadDashboard();
    } else {
      alert('Gagal menghapus: ' + (res.error || ''));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

// ===========================================
// JENIS TRANSAKSI FUNCTIONS
// ===========================================

function showJenisForm() {
  document.getElementById('jenis-form').style.display = 'block';
  document.getElementById('jenis-title').innerText = 'Tambah Jenis';
  document.getElementById('jenis-id').value = '';
  document.getElementById('jenis-nama').value = '';
  document.getElementById('jenis-kategori').value = 'masuk';
}

function hideJenisForm() { 
  document.getElementById('jenis-form').style.display = 'none'; 
}

async function saveJenis() {
  const id = document.getElementById('jenis-id').value;
  const nama = document.getElementById('jenis-nama').value.trim();
  const kategori = document.getElementById('jenis-kategori').value;
  
  if (!nama) {
    alert('Nama jenis wajib diisi');
    return;
  }
  
  try {
    if (id) {
      // Update
      const res = await post('updateJenis', { id, nama_jenis: nama, kategori });
      if (res.success) {
        alert('Jenis transaksi diupdate');
      } else {
        alert('Gagal update: ' + (res.error || ''));
      }
    } else {
      // Add new
      const res = await post('addJenis', { nama_jenis: nama, kategori });
      if (res.success) {
        alert('Jenis transaksi ditambahkan');
      } else {
        alert('Gagal tambah: ' + (res.error || ''));
      }
    }
    
    hideJenisForm();
    loadJenis();
    loadDropdowns();
    
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function loadJenis() {
  try {
    const res = await post('getJenis');
    const tbody = document.querySelector('#jenis-table tbody');
    
    if (!res.success) {
      tbody.innerHTML = '<tr><td colspan="3">Gagal memuat data</td></tr>';
      return;
    }
    
    const data = res.data || [];
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="small">Belum ada jenis transaksi</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.map(r => `
      <tr>
        <td>${escapeHtml(r.nama_jenis)}</td>
        <td>${escapeHtml(r.kategori)}</td>
        <td>
          <button class="btn ghost" onclick="editJenis('${r.id}')">Edit</button>
          <button class="btn" onclick="deleteJenis('${r.id}')">Hapus</button>
        </td>
      </tr>
    `).join('');
    
  } catch (err) {
    debugLog("Load jenis error:", err);
    document.querySelector('#jenis-table tbody').innerHTML = 
      '<tr><td colspan="3">Error memuat data</td></tr>';
  }
}

async function editJenis(id) {
  try {
    const res = await post('getJenis');
    if (!res.success) {
      alert('Gagal memuat data jenis');
      return;
    }
    
    const rec = res.data.find(x => x.id === id);
    if (!rec) {
      alert('Data jenis tidak ditemukan');
      return;
    }
    
    document.getElementById('jenis-id').value = rec.id;
    document.getElementById('jenis-nama').value = rec.nama_jenis;
    document.getElementById('jenis-kategori').value = rec.kategori;
    document.getElementById('jenis-form').style.display = 'block';
    document.getElementById('jenis-title').innerText = 'Edit Jenis';
    
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function deleteJenis(id) {
  if (!confirm('Hapus jenis transaksi ini?')) return;
  
  try {
    const res = await post('deleteJenis', { id });
    if (res.success) {
      alert('Jenis transaksi berhasil dihapus');
      loadJenis();
      loadDropdowns();
    } else {
      alert('Gagal menghapus: ' + (res.error || ''));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

// ===========================================
// TRANSAKSI FUNCTIONS
// ===========================================

async function loadDropdowns() {
  try {
    const [anggotaRes, jenisRes] = await Promise.all([
      post('getAnggota'),
      post('getJenis')
    ]);
    
    const anggotaSel = document.getElementById('transaksi-anggota');
    const jenisSel = document.getElementById('transaksi-jenis');
    
    // Reset dropdowns
    anggotaSel.innerHTML = '<option value="">Pilih Anggota</option>';
    jenisSel.innerHTML = '<option value="">Pilih Jenis Transaksi</option>';
    
    // Isi dropdown anggota
    if (anggotaRes.success && anggotaRes.data) {
      anggotaRes.data.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.nama;
        anggotaSel.appendChild(opt);
      });
    }
    
    // Isi dropdown jenis
    if (jenisRes.success && jenisRes.data) {
      jenisRes.data.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j.id;
        opt.textContent = `${j.nama_jenis} (${j.kategori})`;
        opt.dataset.nama = j.nama_jenis;
        opt.dataset.kategori = j.kategori;
        jenisSel.appendChild(opt);
      });
    }
    
  } catch (err) {
    debugLog("Load dropdowns error:", err);
  }
}

async function saveTransaksi() {
  const id = document.getElementById('transaksi-id').value;
  const tanggal = document.getElementById('transaksi-tanggal').value || new Date().toISOString().slice(0, 10);
  const anggotaId = document.getElementById('transaksi-anggota').value;
  const jenisId = document.getElementById('transaksi-jenis').value;
  const nilaiRaw = document.getElementById('transaksi-nilai').value;
  const nilai = Number(String(nilaiRaw).replace(/,/g, ''));
  const keterangan = document.getElementById('transaksi-keterangan').value.trim();
  
  // Validasi
  if (!tanggal) {
    alert('Tanggal wajib diisi');
    return;
  }
  
  if (!anggotaId) {
    alert('Anggota wajib dipilih');
    return;
  }
  
  if (!jenisId) {
    alert('Jenis transaksi wajib dipilih');
    return;
  }
  
  if (isNaN(nilai) || nilai <= 0) {
    alert('Nilai harus angka dan lebih besar dari 0');
    return;
  }
  
  // Ambil data dari dropdown
  const anggotaText = document.getElementById('transaksi-anggota').selectedOptions[0].textContent;
  const jenisOpt = document.getElementById('transaksi-jenis').selectedOptions[0];
  const jenisNama = jenisOpt.dataset.nama || jenisOpt.textContent;
  const kategori = jenisOpt.dataset.kategori || '';
  
  try {
    if (id) {
      // Update transaksi
      const res = await post('updateTrans', {
        id,
        tanggal,
        anggota_id: anggotaId,
        anggota_nama: anggotaText,
        jenis_id: jenisId,
        jenis_nama: jenisNama,
        kategori,
        nilai,
        keterangan
      });
      
      if (res.success) {
        alert('Transaksi diupdate');
      } else {
        alert('Gagal update: ' + (res.error || ''));
      }
    } else {
      // Tambah transaksi baru
      const res = await post('addTrans', {
        tanggal,
        anggota_id: anggotaId,
        anggota_nama: anggotaText,
        jenis_id: jenisId,
        jenis_nama: jenisNama,
        kategori,
        nilai,
        keterangan
      });
      
      if (res.success) {
        alert('Transaksi berhasil disimpan');
      } else {
        alert('Gagal menyimpan: ' + (res.error || ''));
      }
    }
    
    // Reset form
    document.getElementById('transaksi-id').value = '';
    document.getElementById('transaksi-tanggal').value = '';
    document.getElementById('transaksi-nilai').value = '';
    document.getElementById('transaksi-keterangan').value = '';
    
    // Reload data
    loadTransaksi();
    loadJurnal();
    loadDashboard();
    
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function loadTransaksi() {
  try {
    const res = await post('getTrans');
    const tbody = document.querySelector('#transaksi-table tbody');
    
    if (!res.success) {
      tbody.innerHTML = '<tr><td colspan="6">Gagal memuat data</td></tr>';
      return;
    }
    
    const data = res.data || [];
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="small">Belum ada transaksi</td></tr>';
      return;
    }
    
    // Sort by tanggal terbaru
    data.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
    
    tbody.innerHTML = data.map(r => `
      <tr>
        <td>${r.tanggal}</td>
        <td>${escapeHtml(r.anggota_nama)}</td>
        <td>${escapeHtml(r.jenis_nama)} <span class="small">(${r.kategori})</span></td>
        <td>Rp ${formatNumber(Number(r.nilai) || 0)}</td>
        <td>${escapeHtml(r.keterangan || '')}</td>
        <td>
          <button class="btn ghost" onclick="editTransaksi('${r.id}')">Edit</button>
          <button class="btn" onclick="deleteTransaksi('${r.id}')">Hapus</button>
        </td>
      </tr>
    `).join('');
    
  } catch (err) {
    debugLog("Load transaksi error:", err);
    document.querySelector('#transaksi-table tbody').innerHTML = 
      '<tr><td colspan="6">Error memuat data</td></tr>';
  }
}

async function editTransaksi(id) {
  try {
    const res = await post('getTrans');
    if (!res.success) {
      alert('Gagal memuat data transaksi');
      return;
    }
    
    const rec = res.data.find(x => x.id === id);
    if (!rec) {
      alert('Data transaksi tidak ditemukan');
      return;
    }
    
    // Load dropdowns dulu
    await loadDropdowns();
    
    // Set nilai form
    document.getElementById('transaksi-id').value = rec.id;
    document.getElementById('transaksi-tanggal').value = rec.tanggal;
    document.getElementById('transaksi-anggota').value = rec.anggota_id;
    document.getElementById('transaksi-jenis').value = rec.jenis_id;
    document.getElementById('transaksi-nilai').value = rec.nilai;
    document.getElementById('transaksi-keterangan').value = rec.keterangan || '';
    
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function deleteTransaksi(id) {
  if (!confirm('Hapus transaksi ini?')) return;
  
  try {
    const res = await post('deleteTrans', { id });
    if (res.success) {
      alert('Transaksi berhasil dihapus');
      loadTransaksi();
      loadJurnal();
      loadDashboard();
    } else {
      alert('Gagal menghapus: ' + (res.error || ''));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

// ===========================================
// JURNAL FUNCTIONS
// ===========================================

async function loadJurnal() {
  try {
    const res = await post('getTrans');
    const tbody = document.querySelector('#jurnal-table tbody');
    
    if (!res.success) {
      tbody.innerHTML = '<tr><td colspan="6">Gagal memuat data</td></tr>';
      return;
    }
    
    const data = res.data || [];
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="small">Belum ada transaksi</td></tr>';
      return;
    }
    
    // Sort by tanggal
    data.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
    
    let saldo = 0;
    tbody.innerHTML = data.map(r => {
      const val = Number(r.nilai) || 0;
      let debit = '', kredit = '';
      
      if ((r.kategori || '').toLowerCase() === 'masuk') {
        saldo += val;
        debit = `Rp ${formatNumber(val)}`;
      } else {
        saldo -= val;
        kredit = `Rp ${formatNumber(val)}`;
      }
      
      return `
        <tr>
          <td>${r.tanggal}</td>
          <td>${escapeHtml(r.jenis_nama)} - ${escapeHtml(r.anggota_nama)}</td>
          <td>${debit}</td>
          <td>${kredit}</td>
          <td>Rp ${formatNumber(saldo)}</td>
          <td>
            <button class="btn ghost" onclick="editTransaksi('${r.id}')">Edit</button>
          </td>
        </tr>
      `;
    }).join('');
    
  } catch (err) {
    debugLog("Load jurnal error:", err);
    document.querySelector('#jurnal-table tbody').innerHTML = 
      '<tr><td colspan="6">Error memuat data</td></tr>';
  }
}

// ===========================================
// LAPORAN FUNCTIONS
// ===========================================

async function generateReport() {
  const start = document.getElementById('lap-start').value;
  const end = document.getElementById('lap-end').value;
  const resultDiv = document.getElementById('report-result');
  
  if (!start || !end) {
    alert('Pilih tanggal mulai & tanggal akhir');
    return;
  }
  
  resultDiv.innerHTML = '<div class="small">Memuat laporan...</div>';
  
  try {
    const res = await post('laporan', { from: start, to: end });
    
    if (!res.success) {
      resultDiv.innerHTML = '<div class="small" style="color:#a00">Gagal memuat transaksi: ' + (res.error || '') + '</div>';
      return;
    }
    
    const data = res.data || [];
    
    let pemasukan = 0, pengeluaran = 0;
    data.forEach(t => {
      const v = Number(t.nilai) || 0;
      if ((t.kategori || '').toLowerCase() === 'masuk') {
        pemasukan += v;
      } else {
        pengeluaran += v;
      }
    });
    
    const saldoAkhir = pemasukan - pengeluaran;
    
    resultDiv.innerHTML = `
      <div class="card">
        <div class="small">Periode: <strong>${start}</strong> - <strong>${end}</strong></div>
        <div style="margin-top:8px;">
          <div class="small">Total Pemasukan: <strong>Rp ${formatNumber(pemasukan)}</strong></div>
          <div class="small">Total Pengeluaran: <strong>Rp ${formatNumber(pengeluaran)}</strong></div>
          <div class="small">Saldo Akhir: <strong>Rp ${formatNumber(saldoAkhir)}</strong></div>
        </div>
        <div style="margin-top:12px;overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Anggota</th>
                <th>Jenis</th>
                <th>Nilai</th>
                <th>Keterangan</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(r => `
                <tr>
                  <td>${r.tanggal}</td>
                  <td>${escapeHtml(r.anggota_nama)}</td>
                  <td>${escapeHtml(r.jenis_nama)} (${r.kategori})</td>
                  <td>Rp ${formatNumber(Number(r.nilai) || 0)}</td>
                  <td>${escapeHtml(r.keterangan || '')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    
  } catch (err) {
    resultDiv.innerHTML = '<div class="small" style="color:#a00">Error: ' + err.message + '</div>';
  }
}

// ===========================================
// UTILITY FUNCTIONS
// ===========================================

function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatNumber(n) {
  return Number(n).toLocaleString('id-ID');
}

async function refreshAll() {
  try {
    await Promise.all([
      loadAnggota(),
      loadJenis(),
      loadTransaksi(),
      loadJurnal(),
      loadDashboard()
    ]);
  } catch (err) {
    debugLog("Refresh all error:", err);
  }
}

// ===========================================
// INITIALIZATION
// ===========================================

// Event listeners
document.getElementById('refreshBtn').addEventListener('click', refreshAll);

// Set default date untuk input tanggal
window.addEventListener('load', function() {
  const today = new Date().toISOString().slice(0, 10);
  document.getElementById('transaksi-tanggal').value = today;
  
  // Set default date untuk laporan (bulan ini)
  const firstDay = new Date();
  firstDay.setDate(1);
  document.getElementById('lap-start').value = firstDay.toISOString().slice(0, 10);
  document.getElementById('lap-end').value = today;
  
  // Test API connection
  debugLog('WEB_APP_URL:', WEB_APP_URL);
});

// Show login page initially
showPage('login');

</script>
</body>
</html>
